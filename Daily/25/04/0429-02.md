## TIL

### 데이터베이스 설계 기초와 ERD 이해
- 데이터: 컴퓨터를 사용할 때 불규칙하게 만들어지는 다양하고 많은 값들
- 데이터베이스: 특정 조직 내에서 다수의 사용자들이 공유해 사용할 수 있도록 통합하고 저장한 운영데이터의 집합체
- 데이터베이스 관리 시스템: DBMS, 데이터베이스를 생성하고 안정적이고 효율적으로 운영하는데 필요한 기능들을 제공하는 소프트웨어
- 계층형 데이터베이스(HDBMS)
  - 폴더와 파일등의 계층 구조
  - 트리구조, 부모-자식 형태
  - 종류: 하드디스크, 파일시스템 등
  - 장점: 빠른 속도
  - 단점: 초기 세팅 후 변경 어려움
- 관계형 데이터베이스(RDBMS)
  - 행과 열을 가지는 표 형식 구조
  - SQL을 이용하여 관리 및 접근
  - 종류: Oracle, MySQL, PostgreSQL 등
  - 장점: 범용성, 높은 성능, 무결성, 신뢰성
  - 단점: 컬럼 확장 어려움 -> 수평 확장 어려움
- NoSQL(Not Only SQL)
  - 키-값 or 문서 형식의 비정형 구조
  - 비관계성의 데이터 저장에 유리
  - 종류: Redis, MongoDB, DynamoDB 등
  - 장점: 필드추가 유연성 => 수평확장 용이
  - 단점: 무결성 유지가 필수가 아님
- 백터 데이터베이스(Vector DB)
  - 고차원 벡터 데이터를 임베딩하여 저장
  - 백터간 거리 유사도를 이용한 검색
  - 종류: Chroma, Qdrant, Faiss 등
  - 장점: 이미지, 오디오 등을 백터화하여 저장
  - 단점: AI, RAG등 활용범위 한계
- 관계형 데이터베이스의 특징
  - 데이터의 일관성 유지 - 불일치성(Inconsistency) 방지
  - 데이터 중복 최소화 - 데이터 통합 관리
  - 데이터 무결성 유지 - 무결성(Integrity): 정확한 데이터가 유지되고 있음을 보장
  - 데이터 독립성 유지 - 데이터를 별도로 독립 유지한다

#### 데이터베이스 설계와 ERD
- 행과 열 그리고 관계
  - 데이터가 열과 행의 테이블(또는 관계) 하나 이상에 저장되는 사전 정의된 관계로 데이터를 구성
  - 서로 다른 데이터 구조가 어떻게 서로 연관되어 있는지 쉽게 확인하고 이해
  - 관계는 이러한 테이블 간의 상호작용을 기반으로 설정되는 여러 테이블 간의 논리적 연결
- RDB 용어
  - 데이터베이스는 테이블(Table)이라는 최소 단위로 구성됨
  - 테이블은 하나 이상의 열(Column)과 행(Row)으로 이루어져 있음
- 데이터 아키텍처
  - 데이터베이스 설계 > 개념 모델(분석 & 개략) > 논리 모델(분석 & 상세) > 물리 모델(설계) > DB 스키마(DDL, 구축)
  - 개념 모델: 데이터 모델 첫 단계, 요구사항에 따른 전체적인 모양
  - 논리 모델: 비즈니스 정보 구조 규칙 표현, 누가/어떻게 데이터에 접근하나
  - 물리 모델: 저장할 수 있는 물리적 스키마, 공간, 분산, 저장방법까지 고려
- ERD는?
  - Entity 개체와 Relationship 관계를 중점적으로 표시하는 다이어그램
  - 개체 관계도라고도 불리며 요구분석사항에서 얻은 엔티티와 속성들의 관계를 그림으로 표현한 것
- 엔티티 Entity
  - 정의 가능한 사물 또는 개념, 사람도 될 수 있으며 프로필이나 도서정보와 같은 무형의 정보도 가능
  - 데이터베이스의 테이블이 엔티티로 표현
  - 엔티티 분류
    - 유형 엔티티: 물리적인 형태(고객, 상품, 거래처, 학생, 교수)
    - 무형 엔티티: 물리적 형태가 없고 개념적으로만 존재하는 엔티티(인터넷 장바구니, 부서조직)
    - 문서 엔티티: 업무 절차상에서 사용되는 문서나 장부, 전표(거래명세서, 주문서)
    - 이력 엔티티: 행위와 이력을 시간별로 저장하기 위한 엔티티(입고이력, 구매이력)
    - 코드 엔티티: 각종 코드를 관리하기 위한 엔티티(국가코드, 분류코드)
- 속성 Attribute
  - 엔티티가 갖고 있는 속성
  - 데이터베이스의 각 컬럼(Column)이 속성에 매칭됨
- 도메인 Domain
  - 속성의 값, 타입, 제약사항 등의 대한 값의 범위
  - 데이터베이스가 지원하는 타입에 맞게 설정해야함
  - PostgreSQL, MySQL, Oracle 등 DB 종류에 따라 타입이 다를 수 있음
  - 도메인 타입
    - 숫자형, 정수 유형
      - BIT: 비트값 타입 0과 1로 구성된 binary 값 저장
      - BOOL: 0은 false, 0이 아닌 값은 true로 간주하는 논리형 데이터(ENUM(Y,N) 또는 TINYINT(1)로 대체하여 사용하는 것을 권장)
      - TINYINY(M): 부호 있는 수는 -128 ~ 127, 부호 없는 수는 0 ~ 255까지 표현(1바이트)
      - INT(M), INTEGER(M): 일반적으로 알고 있는 Int 자료형과 그 범위까지 표현(4바이트)
      - BIGINT(M): 일반적으로 알고 있는 BigInt 자료형과 그 범위까지 표현(8바이트)
    - 숫자형, 고정수소점 유형
      - DECIMAL(M,D): M자리 정수(정밀도)와 D자리 소수점(스케일)으로 표현, 최대 65자리까지 표현
    - 숫자형, 부동소수점 유형
      - FLOAT(M,D): 정밀도가 작은 부동소수점을 표현
      - DOUBLE(M,D): 보통 크기의 부동소수점을 표현
    - 날짜형
      - DATE: 날짜를 표현하는 타입(3바이트)
      - DATETIME: 날짜와 시간을 같이 나타내는 타입(8바이트))
      - TIMESTAMP: 1970-01-01 00:00:00 ~ 2037-01-19 03:14:07, INSERT, UPDATE 연산에 유리함(4바이트)
      - TIME: 시간을 표현하는 타입(3바이트)
      - YEAR: 연도를 나타냄(1바이트)
    - 문자형
      - CHAR(M): 고정 길이를 가지는 문자열을 저장함(M: 0 ~ 255)
      - VARCHAR(M): 가변 길이를 가지는 문자열을 저장함(M: 0 ~ 65,535) M이 0 ~ 255이면 문자갈이 +1byte, ~ 65,535이면 문자길이 +2byte
      - BLOB TEXT: 1 ~ 65535개의 가변 길이를 가지는 문자열을 저장함(문자길이 + 2byte), BLOB은 바이너리 데이터, TEXT는 문자 데이터 저장에 유리함
      - LONGBLOB, LONGTEXT: 1 ~ 429,496,729개의 가변 길이를 가지는 문자열을 저장함(문자길이 + 4byte)
      - ENUM: 문자 value를 숫자로 저장하여 최대 65,535개의 문자열 중 한가지를 반환 255 이하 value는 1바이트, 65,535이하 value는 2바이트
- 기본키 Primary Key(PK)
  - 특정 레코드를 유일하게 식별하기 위해 사용되는 필드
  - 테이블의 각 레코드에는 Primary Key가 반드시 있어야함
  - Unique: 각 레코드에 대해 공유함
  - Not Null: Null 값이 허용되지 않음
  - Primary Key는 한 테이블에 한 개만 존재할 수 있음
  - 하지만 꼭 한 테이블에 한 컬럼만 기본키로 지정할 수 있는 것은 아님
  - Primary Key를 여러 컬럼을 조합하여 설정할 수 있음, 이 경우를 Composite Key 복합키라고 부름
- 외래키 Foreign Key(FK)
  - Foreign Key는 두 테이블 사이의 관계를 연결해주고, 그 결과 데이터의 무결성을 보장해주는 역할을 함
  - 외래 키가 설정된 열은 꼭 다른 테이블의 기본 키와 연결되어야 함
  - 외래 키를 설정한 경우 기준 테이블의 기본 키 값을 수정하거나 삭제하려고 할 경우 오류가 발생함
  - 이 경우 CASCADE문을 이용하면 참조 테이블 값도 함께 변경할 수 있음

-----

### SQL 기초와 인덱스 이해
- Structured Query Language
- SQL 구조화 질의어, SQL은 관계형 데이터베이스 관리 시스템의 데이터를 관리하기 위해 설계한 특수 목적의 선언형 언어(<=> 명령형 언어)
- 관계형 데이터베이스 관리 시스템에서 자료의 검색과 관리, 데이터베이스 스키마 생성과 수정, 데이터베이스 객체 접근 조정 관리를 위해 고안됨
- SQL 정의
  - DDL(Data Definition Language) 데이터 정의어
  - DML(Data Manipulation Language) 데이터 조작어
  - DCL(Data Control Language) 데이터 제어어
  - TCL(Transaction Control Language) 트랜잭션 제어어

#### SQL 기본 문법
- DDL
  - CREATE: 사용자, 데이터베이스 혹은 테이블 등 다양한 DB 객체를 생성함
  ```sql
  create table mydb.mytab(col1 integer primary key, col2 varchar(20));
  ```
  - ALTER: 변경, 기존 테이블과 해당 컬럼의 특성을 변경함
  ```sql
  alter table mytab add col3 char(2);
  ```
  - DROP TABLE: 기존 테이블 삭제
  ```sql
  drop table mytab;
  ```
- DML
  - SELECT: 테이블 데이터를 조회함
  ```sql
  // 조건 where
  select * from alerts.status where Severity = 4;
  // 조건 where like
  select * from alerts.status where Node like '%terminal%';
  // 가상 컬럼
  select Severity, Severity + Tally from alerts.status;
  // 스킵
  select skip 2 top 5 node from alerts.status
  // 정렬
  select * from alerts.status order by Node asc
  ```
  - INSERT: 테이블에 새로운 데이터를 추가함
  ```sql
  insert into mydb.mystatus(Identifier, Severity, LastOccurrence)
  values('MasterMachineStats15', 5, getdate);
  ```
  - UPDATE: 테이블의 기존 데이터를 수정할 때 사용함
  ```sql
  update alerts.status set Severity = 0 where Node = 'Fred';
  ```
  - DELETE: 기존 테이블에서 하나 이상의 행을 삭제함
  ```sql
  delete from alerts.status where Node = 'Fred';
  ```
- DCL
  - GRANT: 특정 역할을 부여하는 명령어
  ```sql
  grant drop on database testdb to role 'DDL_Admin';
  ```
  - REVOKE: 권한을 회수해 오는 명령어
  ```sql
  revoke create table from role 'DDL_Admin';
  ```
- TCL: COMMIT, ROLLBACK, SAVEPOINT
- SQL문 작성 규칙
  - SQL문은 대/소문자 구분하지 않음
  - 한 줄 또는 여러 줄로 작성할 수 있음
  - 문장 마지막은 세미콜론으로 끝남
  - 명령어, 객체명, 변수명은 대/소문자 구분이 없음
  - 데이터 값은 대/소문자 구분함
  - 날짜와 문자열에는 작은 따옴표를 사용
  - 단어와 단어 사이는 공백 또는 줄바꿈으로 구분

#### 인덱스
- 인덱스 == 사전의 '색인'
  - 테이블의 동작속도(조회)를 높여주는 자료구조
  - 데이터의 위치를 빠르게 찾아주는 역할('홍길동'이라는 단어를 찾고 싶으면 색인페이지에서 '홍'으로 시작하거나 'ㅎ'으로 시작하는 색인을 찾아보면 빠르게 찾을 수 있음
  - B+ Tree 자료구조
    - MySQL의 Primary Key와 Foreign Key는 기본적으로 Index가 적용되어 있음
    - Clustered Index(테이블의 실제 데이터는 인덱스 순서대로 저장됨)로 B+트리 구조를 사용함
  - 장점/필요사항
    - 빠른 데이터 검색: 인덱스는 WHERE, JOIN, ORDER BY 등의 조건에서 전체 테이블 스캔을 피하고, 빠른 검색을 가능하게 함
    - 효율적인 범위 검색: B+ 트리 구조 덕분에 정렬된 데이터에 대해 범위 검색이나 순차 검색이 효과적임
    - 시스템 부하 감소: 불필요한 I/O와 CPU 사용을 줄여 전체 쿼리 성능을 향상시킴
  - 단점/주의사항
    - 추가 저장 공간 필요: 인덱스 생성 시 별도의 저장 공간이 소요되므로, 저장 용량 관리에 주의해야함
    - 데이터 수정 시 오버헤드 증가: INSERT, UPDATE, DELETE와 같이 데이터 변경 시 인덱스도 함께 갱신되어 성능 저하가 발생할 수 있음
    - 과도한 인덱스는 부작용: 필요 이상의 인덱스는 오히려 쿼리 최적화를 방해할 수 있으므로, 적절한 인덱스 설계와 관리가 중요함

-----

### 고급 SQL: 효율적인 데이터 조회
- 테이블 조인과 서브 쿼리
  - 여러 테이블에 분산된 데이터를 하나의 결과 집합으로 결합하기 위한 SQL 기법
  - 테이블 간 공유하는 공통 컬럼을 기준으로 테이블을 연결함
  - 분리된 테이블 간의 관계를 활용하여, 하나의 의미 있는 결과를 도출함
  - 필요한 정보를 여러 테이블에서 동시에 검색하여 효율적인 데이터 검색 가능
- 테이블 조인
  - INNER JOIN: 두 테이블을 PK-FK로 된 것을 기준으로 테이블을 합침(단, 공통된 조건이 있는 값만)
  - LEFT OUTER JOIN: INNER JOIN처럼 합치지만 LEFT 테이블의 공통된 것이 없어도 그 값을 합침
  - RIGHT OUTER JOIN: 마찬가지지만 RIGHT 테이블의 공통된 것이 없어도 그 값을 합침
  - INNER JOIN은 일종의 교집합이고, OUTER JOIN은 교집합을 포함한 차집합이라고 볼 수 있음
 - 서브 쿼리: 아래의 예시를 보면 말 그대로 하나의 테이블에 대해서 추가적인 쿼리문을 통해서 조건을 좀 더 복잡하게 해서 테이블을 조작할 수 있음
   - SELECT 절 서브쿼리: 스칼라 서브쿼리
   ```sql
   SELECT
     회원ID,
     이름,
     "비공개" AS 연봉,
     (SELECT MAX(연봉) FROM 사원) AS 최고연봉 FROM 동호회
   ```
   - FROM 절 서브쿼리: 인라인뷰
   ```sql
   SELECT
     동호회.*, 연봉 4000이상.*
   FROM
     동호회 INNER JOIN (
       SELECT
         사원.*
       FROM 사원
       WHERE 연봉 > 4000
     ) 연봉4000이상
     ON 동호회.사번 = 연봉4000이상.사번 
   ```
   - WHERE 절 서브쿼리
   ```sql
   SELECT
     *
   FROM 사원
   WHERE 사번 IN (
     SELECT
       사번
     FROM 동호회
     WHERE 회원ID > 101
   )
   ```

#### 윈도우 함수와 집계 함수
- 윈도우 함수 Window Functions
  - 조회결과(윈도우) 내에서 계산하는 함수
  - OVER 절과 사용
  - 원래의 행을 유지하며, 계산 결과를 각 행에 추가
  - ROW_NUMBER, RANK, DENSE_RANK...
- 집계 함수 Aggregate Functions
  - 여러 행의 값을 요약하여 그룹 단위로 결과 반환
  - GROUP BY절과 사용, 요약
  - 결과 행 수를 축소시켜 하나의 값만 반환
  - COUNT, SUM, AVG, MIN, MAX...
- 윈도우 함수
  - ROW_NUMBER()
    - 단순히 각 행에 대해 순차적인 번호 부여
    - 동일한 값을 가진 행이 있더라도, 각 행은 고유한 번호 부여
  - RANK()
    - 동일한 값이 있을 경우, 같은 순위 부여
    - 그 다음 순위는 건너뛰어짐
    - 동일한 값의 행에는 동일한 순위를 부여
    - 순위 사이에 간격이 발생
  - DENSE_RANK()
    - RANK()와 유사하게 동일한 값에 같은 순위 부여
    - 건너뛰는 순위 없이 연속적인 순위 부여
    - 동일한 값의 행에는 동일한 순위를 부여
    - 다음 순위는 바로 직전 순위에 있던 데이터 수만큼 증량
- 집계 함수
  - COUNT(): 갯수
  - COUNT() 갯수 - GROUP BY
  - SUM(): 합계
  - SUM() 합계 - GROUP BY
  - AVG(): 평균
  - AVG() 평균 - GROUP BY
  - MIN() GROUP BY: 최솟값
  - MAX() GROUP BY: 최댓값
